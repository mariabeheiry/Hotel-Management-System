@model List<Hotel_Management_System.Models.Room>
@using Hotel_Management_System.Helpers
@inject IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Confirm Booking";

    var cart = HttpContextAccessor.HttpContext.Session.GetObject<List<int>>("RoomCart") ?? new List<int>();
    var checkInString = HttpContextAccessor.HttpContext.Session.GetString("CheckIn");
    var checkOutString = HttpContextAccessor.HttpContext.Session.GetString("CheckOut");

    DateTime checkIn = string.IsNullOrEmpty(checkInString) ? DateTime.Today : DateTime.Parse(checkInString);
    DateTime checkOut = string.IsNullOrEmpty(checkOutString) ? DateTime.Today.AddDays(1) : DateTime.Parse(checkOutString);

    int nights = (int)(checkOut - checkIn).TotalDays;
    if (nights < 1) nights = 1;

    decimal finalTotal = 0;
}

<h2>Confirm Your Booking</h2>

@if (!cart.Any())
{
    <div class="alert alert-info">
        Your cart is empty.
        <a asp-action="Search" asp-controller="Bookings">Search rooms</a> first.
    </div>
}
else
{
    <div class="mb-3">
        <p><strong>Check-In:</strong> @checkIn.ToString("yyyy-MM-dd")</p>
        <p><strong>Check-Out:</strong> @checkOut.ToString("yyyy-MM-dd")</p>
        <p><strong>Nights:</strong> @nights</p>
    </div>

    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>Room Number</th>
                <th>Type</th>
                <th>Price per Night</th>
                <th>Nights</th>
                <th>Total Price</th>
                <th>Remove</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var room in Model)
            {
                decimal total = room.Price * nights;
                finalTotal += total;

                <tr>
                    <td>@room.RoomNumber</td>
                    <td>@room.RoomType</td>
                    <td>@room.Price.ToString("F2") EGP</td>
                    <td>@nights</td>
                    <td>@total.ToString("F2") EGP</td>
                    <td>
                        <form method="post" asp-action="RemoveFromCart">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="roomId" value="@room.RoomID" />
                            <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <div class="alert alert-dark text-end fs-5">
        <strong>Final Total:</strong> @finalTotal.ToString("F2") EGP
    </div>

    <div class="mt-3 d-flex justify-content-between align-items-center">
        <div>
            <form method="post" asp-action="ConfirmBooking">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-success btn-lg">Confirm Booking</button>
            </form>
        </div>

        <div>
            <a asp-action="Search" asp-controller="Bookings" class="btn btn-secondary">Back to Search</a>
        </div>
    </div>
}